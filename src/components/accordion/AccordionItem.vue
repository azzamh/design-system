<template>
  <div
    :class="classNames"
    data-testid="accordion-item"
    :disabled="disabled">
    <slot
      name="activator"
      :toggle="toggle"
      :expanded="model">
      <div
        class="accordion__item__activator"
        data-testid="accordion-item-activator"
        @click="toggle">
        <Subheading class="accordion__item__title">
          {{ title }}
        </Subheading>
        <slot
          v-if="!noCaret"
          name="caret"
          :expanded="model">
          <ChevronUp
            v-if="model"
            class="accordion__item__caret"
            data-testid="accordion-item-caret" />
          <ChevronDown
            v-else
            class="accordion__item__caret"
            data-testid="accordion-item-caret" />
        </slot>
      </div>
    </slot>

    <p-collapse
      :model-value="model"
      class="accordion__item__content"
      data-testid="accordion-item-content">
      <slot :expanded="model" />
    </p-collapse>
  </div>
</template>

<script lang="ts" setup>
import { useVModel } from '../input'
import type { VNode } from 'vue-demi'
import { computed, watch } from 'vue-demi'

import Subheading from '../subheading/Subheading.vue'
import pCollapse from '../collapse/Collapse.vue'
import ChevronUp from '@privyid/persona-icon/vue/chevron-up/16.vue'
import ChevronDown from '@privyid/persona-icon/vue/chevron-down/16.vue'

defineOptions({ name: 'AccordionItem' })

const props = defineProps({
  modelValue: {
    type   : Boolean,
    default: false,
  },
  title: {
    type   : String,
    default: '',
  },
  disabled: {
    type   : Boolean,
    default: false,
  },
  noCaret: {
    type   : Boolean,
    default: false,
  },
})
const emit  = defineEmits<{
  'update:modelValue': [boolean],
  'expand': [],
  'collapse': [],
}>()

const model = useVModel(props)

const classNames = computed(() => {
  const result: string[] = ['accordion__item']

  if (props.disabled)
    result.push('accordion__item--disabled')

  if (model.value)
    result.push('expanded')
  else
    result.push('collapsed')

  return result
})

function toggle () {
  if (!props.disabled)
    model.value = !model.value
}

watch(model, (value) => {
  if (value)
    emit('expand')
  else
    emit('collapse')
})

defineSlots<{
  'activator'(props: { toggle: () => void, expanded: boolean }): VNode[],
  'caret'(props: { expanded: boolean }): VNode[],
  'default'(props: { expanded: boolean }): VNode[],
}>()
</script>

<style lang="postcss">
.accordion__item {
  --p-accordion-bg: theme(backgroundColor.default.DEFAULT);
  --p-accordion-bg-dark: theme(backgroundColor.dark.default.DEFAULT);
  --p-accordion-collapsed-border: theme(borderColor.default.DEFAULT);
  --p-accordion-collapsed-border-dark: theme(borderColor.dark.default.DEFAULT);
  --p-accordion-expanded-border: theme(borderColor.default.DEFAULT);
  --p-accordion-expanded-border-dark: theme(borderColor.dark.default.DEFAULT);

  @apply w-full bg-[color:var(--p-accordion-bg)];
  @apply dark:bg-[color:var(--p-accordion-bg-dark)];

  &:not(.accordion &) {
    @apply rounded border;

    &.collapsed {
      @apply border-[color:var(--p-accordion-collapsed-border)];
      @apply dark:border-[color:var(--p-accordion-collapsed-border-dark)];
    }

    &.expanded {
      @apply border-[color:var(--p-accordion-expanded-border)];
      @apply dark:border-[color:var(--p-accordion-expanded-border-dark)];
    }

    .accordion__item__activator {
      @apply bg-default-alpha;
      @apply dark:bg-dark-default-alpha;
    }
  }

  &__activator {
    @apply flex justify-between items-center p-4 cursor-pointer;

    .expanded & {
      @apply bg-default-alpha;
      @apply dark:bg-dark-default-alpha;
    }
  }

  &:is(&--disabled) {
    @apply pointer-events-none;

    > .accordion__item__activator {
      @apply opacity-50;
    }
  }
}
</style>
